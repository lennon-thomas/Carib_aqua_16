---
title: "carib_results"
author: "Lennon Thomas"
date: "2/8/2018"
output: html_document
---

```{r setup, warning=FALSE , echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, fig.width = 6.5)
```



```{r echo = FALSE}
# Load packages and functions-----------------------------------------------------------
rm(list = ls())

library(raster)
library(rgdal)
library(tmap)
library(ncdf4)
library(stringr)
library(broom)
library(fasterize)
library(sf)
library(tidyverse)
library(parallel)
library(R.utils)
library(readr)
library(pander)
#library(plotly)
# library(plyr)

# Run settings -------------------------------------------------------------

## Set User (lennon/tyler)
user <- 'lennon'

if(user == 'lennon') { boxdir <- '/Users/lennonthomas/Box Sync/Waitt Institute/Blue Halo 2016/Carib_aqua_16/'}
if(user == 'tyler')  { boxdir <-  '../../Box Sync/Carib_aqua_16/'}

run_name = 'est_feb_8'  
# Load EEZ shapefile for plotting

EEZ = readOGR(dsn=paste(boxdir,"Suitability/tmp",sep = ""),layer="carib_eez_shape")

# Load suitablity results
s_areas<-gzfile(paste0(boxdir,"/results/Suitability/suitable_areas.rds"))

suit_areas<-readRDS(s_areas)

suit_df<-read_csv(paste0(boxdir,"/results/Suitability/suitable_area_df.csv"),
                  col_types = "iiddiic") %>%
  select(c("cell_no","study_area_km","suit_area_km","suit_index","eez","country"))

# Load sim data

data_folder <- paste0(boxdir,'results/',run_name,"/Data/")

data.names <- list.files(path = data_folder, pattern = ".nc")

data_files <- lapply(paste0(data_folder,"/",data.names),brick)

avg_growth<-data_files[[1]]

harv_cycle_length<-data_files[[2]]

no_cycles<-data_files[[3]]

stocking_n<-data_files[[4]]

rm(data_files)

# Load run results 
  #"calc_0.02" #run name reflects intital stocking density (calculated or fixed)and feed rates (as % body weight)

result_folder <- paste0(boxdir,'results/',run_name,"/Results")

file.names <- list.files(path = result_folder, pattern = ".csv")

result_files <- lapply(paste0(result_folder,"/",file.names),read_csv)

carib_supply<-result_files[[1]]

eez_supply_df<-result_files[[2]]

npv_df<-result_files[[4]]

supply_summary<-result_files[[6]]

rm(result_files)
```


## Suitability Analysis

We estimated `r sum(suit_df$suit_area_km,na.rm = TRUE)` km^2^, or `r round((sum(suit_df$suit_area_km,na.rm = TRUE))/(sum(suit_df$study_area_km,na.rm = TRUE)) *100,2)`% of the total study area (Fig.1).
```{r}
EEZ$MRGID<-{as.numeric(levels(EEZ$MRGID))[EEZ$MRGID]}

country_code<-as.data.frame(EEZ@data[c("MRGID","Territory1"),])

country<-raster(paste0(boxdir,"Suitability/tmp/carib_eez_raster.tif"))
  #rasterize(EEZ,suit_areas,field = 'MRGID')

suit<-as.data.frame(rasterToPoints(suit_areas)) %>%
  set_names(c("Longitude","Latitude","suitable"))

country_area<-area(suit_areas,na.rm=TRUE)

country_suitable<-zonal(country_area,country,fun='sum')

country_suitable<-as.data.frame(country_suitable)

country_s_area<-cbind(country_suitable,EEZ$MRGID,as.character(EEZ$Territory1)) %>%
 select(c(2,3,4)) %>%
 purrr::set_names(c("Area","MRGID","EEZ")) %>%
 arrange(desc(Area)) %>%
 select("EEZ","Area","MRGID")

#pull out long/lat coords and cell number of suitable cell raster layer for mapping stuff later

ras_cells<-Which(country_area>0,cells = TRUE)

raster_coords<-as.data.frame(cbind(suit$Longitude,suit$Latitude,ras_cells)) %>%
  set_names(c("Longitude","Latitude","cell"))

```

`r as.character(country_s_area$EEZ[1])` had the largest suitable area and `r as.character(country_s_area[country_s_area$Area==0,1])` did not have any areas identified as suitable for offshore mariculture.


```{r Fig. 1 echo = FALSE}

#Read in suitability results and make ggplot of suitable areas

  EEZ@data$suitable<-country_suitable$sum

  # Adding text column to spatial data frame so the plotly can show the total suitable area by eez
  EEZ@data$mytext<-paste0("EEZ =",EEZ@data$Territory1, "/n", "Suitable area (km^2) = ", EEZ@data$suitable)
  
  # Not sure if plotting from fortified data frame makes things better or not...(Maybe easier for plotly, but not using for now)
  # EEZ@data$id<-rownames(EEZ@data)
  # EEZ.points<-fortify(EEZ, region="id")
  # EEZ.df<-join(EEZ.points,EEZ@data,by="id")
  # 
  # # Gets rid of values for polygons that are land
  # EEZ.df$suitable<-ifelse(EEZ.df$hole==TRUE,NA,EEZ.df$suitable)

  #  p<-ggplot(EEZ,aes(text = mytext)) + 
  #   geom_polygon( aes(long, lat, group = group, fill = hole), colour = "black", size = 0.1) + 
  #   scale_fill_manual(values = (c("lightblue", "white")),guide = FALSE) + 
  #   theme(legend.position="none") +
  #   theme_minimal() +
  #   geom_raster(data=suit,aes(x=Longitude,y=Latitude,fill=suitable),fill="darkred") +
  #   xlab("Longitude") +
  #   ylab("Latitude") +
  #   coord_fixed(xlim =c(-85.5,-57.4),ylim = c(9.95,30))
  # 
  # plotly(p)
  
  
  ggplot() + 
    geom_polygon(data=EEZ, aes(long, lat, group = group, fill = hole), colour = "black", size = 0.1) + 
    scale_fill_manual(values = (c("lightblue", "white")),guide = FALSE) + 
    theme(legend.position="none") +
    theme_minimal() +
    geom_raster(data=suit,aes(x=Longitude,y=Latitude,fill=suitable),fill="darkred") +
    xlab("Longitude") +
    ylab("Latitude") +
    coord_fixed(xlim =c(-85.5,-57.4),ylim = c(9.95,30))


```


## Production

```{r}

# Start summarizing and plotting production/npv results

#npv_df$cell<-as.factor(npv_df$cell)
#npv_df$eez<-as.factor(npv_df$eez)

# Filter out for price == 8 

npv_df_pr<-npv_df %>%
  filter(prices == 9) %>%
  filter(discounts== 0.05)

npv_df_pr<-left_join(npv_df_pr,raster_coords)
 
#Still not working quite right.
 ggplot() + 
    geom_polygon(data=EEZ, aes(long, lat, group = group, fill = hole), fill="white",colour = "black", size = 0.1) + 
   # scale_fill_manual(values = (c("lightblue", "white")),guide = FALSE) + 
    theme(legend.position="none") +
    theme_minimal() +
    geom_raster(data=npv_df_pr,aes(x=Longitude,y=Latitude,fill=npv)) +
    scale_color_continuous(guide="colorbar",na.value="white",low="darkred",high="darkblue") +
    xlab("Longitude") +
    ylab("Latitude") +
    coord_fixed(xlim =c(-85.5,-57.4),ylim = c(9.95,30))



```

```{r}
# box plots of npv for each discount rate by npv
bp_data<-npv_df %>%
  filter(prices==9)
bp_data$discounts<-as.factor(bp_data$discounts)

ggplot(bp_data,aes(x=discounts,y=npv))+
  geom_boxplot() +
  theme_minimal()+
  facet_grid(~eez) +
  xlab("Discount Rate") +
  ylab("10 yr NPV")

```

